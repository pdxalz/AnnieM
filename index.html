<!DOCTYPE html>
<html lang="en">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<head>
    <title>Sauvie Wind Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript">
    </script>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" language="javascript">
        var mqtt;
        var reconnectTimeout = 10000;
        var host = "test.mosquitto.org";//change this
        var port = 8081;
        var row_ctr = 1;
        var xValues = [];
        var yValues = [];
        var dirValues = [];
        var chart;
        var windData = [];
        var latestTime = new Date(0);

        function onFailure(message) {
            console.log("Connection Attempt to Host " + host + "Failed");
            setTimeout(MQTTconnect, reconnectTimeout);
        }
        function onMessageArrived(msg) {
            // out_msg="Message received "+msg.payloadString+"<br>";
            // out_msg=out_msg+"Message received Topic "+msg.destinationName;
            // console.log(out_msg);
            var wind_data = msg.payloadString;
            // console.log("Wind data: " + wind_data);
            // var wind_topic = msg.destinationName;
            // console.log("Topic: " + wind_topic);
            // fixed_json = wind_data.replace('{"w', '"w');
            // console.log("My fixed json data: " + fixed_json + "}");
            // wind.push(wind_data);
            // showWind(wind_data);
            // console.log(wind);
            console.log("dest: :" + msg.destinationName);

            if (msg.destinationName.search("recent") >= 0) {
                addDataToRecent(wind_data);
            } else {
                plotWindData(wind_data);
            }
        }

        function directionString(direction) {
            const dir_dict = {
                0: "N",
                1: "NE",
                2: "E",
                3: "SE",
                4: "S",
                5: "SW",
                6: "W",
                7: "NW"
            }
            var dir_num = Number(direction);
            var dir_index = Math.floor(((dir_num + 22) % 360) / 45);
            var dir_remainder = (dir_num - dir_index * 45);
            dir_remainder = (dir_remainder > 23) ? dir_remainder - 360 : dir_remainder;
            return dir_dict[dir_index] + " " + "<small>" + dir_remainder + "</small>";
        }

        function addDataToRecent(recent_data) {
            try {
                recent_json = JSON.parse(recent_data);
            }
            catch (err) {
                console.log(err.message);
            }

            var wind_table = document.getElementById("recent-wind");


            wind_table.innerHTML =

                "<h2>" + " Current conditions at " + recent_json.time + "<br>" + " speed: " + recent_json.sp +
                " Direction: " + directionString(recent_json.dir) + "(" + recent_json.dir + ")" + "</h2>" +
                " battery: " + recent_json.mv;
            recent_json.mv;

        }



        function northCenter(degrees) {
            if (degrees < 180)
                degrees += 360;
            return degrees / 18;
        }

        function plotWindData(wind_data) {
            try {
                wind_json = JSON.parse(wind_data);
            }
            catch (err) {
                console.log(err.message);
            }


            var time = new Date(wind_json.time);
            time.setTime(time.getTime() + (7 * 60 * 60 * 1000));  // Need to remove UTC offset in Annie code

            console.log("timestamp: " + wind_json.time + "   latest: ", latestTime);

            var hour = time.getHours();
            windData[hour] = wind_json.wind;

            // keep track of the most recent time read
            if (time > latestTime) {
                latestTime = time;
            }
            else {
                // return;
            }

            // strip off the 0,0 "no data" values off the end.
            for (var i = windData[hour].length - 1; i >= 0; --i) {
                if (windData[hour][i][0] == 0 && windData[hour][i][1] == 0) {
                    windData[hour].pop();
                }
                else {
                    break;
                }
            }

            var x = [];
            var y = [];
            var dirData = [];
            var hour = latestTime.getHours();
            var i;
            // i = hour - 2;
            // if (hour > 10) {
            //     i = hour - 1;
            //     for (var j = 0; j < windData[i].length; ++j) {
            //         x.push(j == 0 ? i + 1 : "");
            //         y.push(windData[i][j][0]);
            //     }

            // }


            for (i = 0; i < windData.length; ++i) {
                var index = (hour + i + 1) % windData.length;
                console.log("winddata: " + windData.length + "  " + i + " >> " + windData[index]);
                for (var j = 0; j < windData[index].length; ++j) {
                    x.push(j == 0 ? index : "");
                    y.push(windData[index][j][0]);
                    dirData.push(northCenter(windData[index][j][1]));
                }
                console.log("y:" + hour + " " + y);
            }
            // var start = (hour < 8) ? 0 : hour - 6;
            // for (var i = 0; i < hour; ++i) {
            //     if (windData[i] !== undefined) {
            //         for (var j = 0; j < windData[i].length; ++j) {
            //             x.push(j == 0 ? i + 1 : "");
            //             y.push(windData[i][j][0]);
            //         }

            //     }
            // }

            chart.data.datasets[0].data = y;
            chart.data.datasets[1].data = dirData;
            chart.data.labels = x;
            console.log(windData[hour]);
            console.log("speed:", hour);
            chart.update();
        }

        function showWind(wind_data) {
            try {
                wind_json = JSON.parse(wind_data);
            }
            catch (err) {
                console.log(err.message);
            }
            wind = wind_json.wind;
            storeWind(wind);
        }

        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.

            console.log("Connected ");
            mqtt.subscribe("zimbuktu/wind/#");
            mqtt.subscribe("zimbuktu/recent/#");
            // message = new Paho.MQTT.Message("Hello World");
            // message.destinationName = "sensor2";
            // message.retained=true;
            // mqtt.send(message);
        }

        function MQTTconnect() {
            console.log("connecting to " + host + " " + port);
            var x = Math.floor(Math.random() * 10000);
            var cname = "orderform-" + x;
            mqtt = new Paho.MQTT.Client(host, port, cname);
            //document.write("connecting to "+ host);
            var options = {
                timeout: 3,
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: true
            };
            mqtt.onMessageArrived = onMessageArrived

            mqtt.connect(options); //connect
        }

    </script>
</head>

<body>
    <h1>Sauvie Island Wind Conditions</h1>
    <p> The blue line is the direction.  North is at the center of the chart.
    </p>
    <p> Updates occur every 5 minute from 10AM to 9PM if it is windy. Otherwise only on the hour.</p>
    <!--        <h3>Current Speed/Direction:</h3> -->
    <p id="recent-wind"></p>
    <table id="wind-table">
        <tr>
            <th>Time</th>
            <th>Wind Speed (mph)</th>
            <th>Wind Direction (deg)</th>
        </tr>
    </table>

         <div style="direction: rtl; width: 50%; overflow-x: auto; overflow-y: hidden;">
            <div style="width:2000px; height: 500px">
                <canvas id="myChart" height="500" width="0"></canvas>
            </div>
        </div>

    <script>
        MQTTconnect();

        chart = new Chart("myChart", {
            type: "line",
            data: {
                labels: xValues,
                datasets: [{
                    label: "Wind Speed",
                    pointRadius: 1,
                    pointBackgroundColor: "rgb(0,0,255)",
                    data: yValues,
                    borderColor: "green"
                }, {
                    label: "Direction (North at middle)",
                    pointRadius: 1,
                    pointBackgroundColor: "rgb(0,0,255)",
                    data: dirValues,
                    borderColor: "blue",
                    fill: false,
                    borderWidth: -1
                },
                ]
            },
            options: {
                legend: { display: true },

                scales: {
                    xAxes: [{ ticks: { min: 40, max: 290 } }],
                    yAxes: [{ position: 'right', ticks: { min: 0, max: 40 } }, { position: 'right', ticks: { min: -2, max: 2 } }],
                }
            }
        });
        console.log("chart: ", yValues);

    </script>
</body>

</html>